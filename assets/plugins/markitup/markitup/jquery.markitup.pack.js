// ----------------------------------------------------------------------------
// markItUp! Universal MarkUp Engine, JQuery plugin
// v 1.1.6.1
// Dual licensed under the MIT and GPL licenses.
// ----------------------------------------------------------------------------
// Copyright (C) 2007-2010 Jay Salvat
// http://markitup.jaysalvat.com/
// ----------------------------------------------------------------------------
(function(b){b.fn.markItUp=function(t,g){var A,H,c,h,n,w;h=n=w=!1;"string"==typeof t&&(A=t,H=g);c={id:"",nameSpace:"",root:"",previewHandler:!1,previewInWindow:"",previewInElement:"",previewAutoRefresh:!0,previewPosition:"after",previewTemplatePath:"~/templates/preview.html",previewParser:!1,previewParserPath:"",previewParserVar:"data",resizeHandle:!0,beforeInsert:"",afterInsert:"",onEnter:{},onShiftEnter:{},onCtrlEnter:{},onTab:{},markupSet:[{}]};b.extend(c,t,g);c.root||b("script").each(function(P,
h){miuScript=b(h).get(0).src.match(/(.*)jquery\.markitup(\.pack)?\.js$/);null!==miuScript&&(c.root=miuScript[1])});var x=function(b){b=b.toLowerCase();b=/(chrome)[ \/]([\w.]+)/.exec(b)||/(webkit)[ \/]([\w.]+)/.exec(b)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(b)||/(msie) ([\w.]+)/.exec(b)||0>b.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(b)||[];return{browser:b[1]||"",version:b[2]||"0"}}(navigator.userAgent),l={};x.browser&&(l[x.browser]=!0,l.version=x.version);l.chrome?l.webkit=!0:
l.webkit&&(l.safari=!0);return this.each(function(){function g(a,b){return b?a.replace(/("|')~\//g,"$1"+c.root):a.replace(/^~\//,c.root)}function t(){nameSpace=id="";c.id?id='id="'+c.id+'"':d.attr("id")&&(id='id="markItUp'+d.attr("id").substr(0,1).toUpperCase()+d.attr("id").substr(1)+'"');c.nameSpace&&(nameSpace='class="'+c.nameSpace+'"');d.wrap("<div "+nameSpace+"></div>");d.wrap("<div "+id+' class="markItUp"></div>');d.wrap('<div class="markItUpContainer"></div>');d.addClass("markItUpEditor");B=
b('<div class="markItUpHeader"></div>').insertBefore(d);b(x(c.markupSet)).appendTo(B);I=b('<div class="markItUpFooter"></div>').insertAfter(d);!0===c.resizeHandle&&!0!==l.safari&&(resizeHandle=b('<div class="markItUpResizeHandle"></div>').insertAfter(d).bind("mousedown.markItUp",function(a){var f=d.height(),c=a.clientY,p,e;p=function(a){d.css("height",Math.max(20,a.clientY+f-c)+"px");return!1};e=function(a){b("html").unbind("mousemove.markItUp",p).unbind("mouseup.markItUp",e);return!1};b("html").bind("mousemove.markItUp",
p).bind("mouseup.markItUp",e)}),I.append(resizeHandle));d.bind("keydown.markItUp",J).bind("keyup",J);d.bind("insertion.markItUp",function(a,f){!1!==f.target&&C();e===b.markItUp.focused&&u(f)});d.bind("focus.markItUp",function(){b.markItUp.focused=this});c.previewInElement&&K()}function x(a){var f=b("<ul></ul>"),c=0;b("li:hover > ul",f).css("display","block");b.each(a,function(){var a=this,e="",k,h;k=a.key?(a.name||"")+" [Ctrl+"+a.key+"]":a.name||"";key=a.key?'accesskey="'+a.key+'"':"";if(a.separator)e=
b('<li class="markItUpSeparator">'+(a.separator||"")+"</li>").appendTo(f);else{c++;for(h=y.length-1;0<=h;h--)e+=y[h]+"-";e=b('<li class="markItUpButton markItUpButton'+e+c+" "+(a.className||"")+'"><a href="" '+key+' title="'+k+'">'+(a.name||"")+"</a></li>").bind("contextmenu.markItUp",function(){return!1}).bind("click.markItUp",function(a){a.preventDefault()}).bind("focusin.markItUp",function(){d.focus()}).bind("mouseup",function(){a.call&&eval(a.call)();setTimeout(function(){u(a)},1);return!1}).bind("mouseenter.markItUp",
function(){b("> ul",this).show();b(document).one("click",function(){b("ul ul",B).hide()})}).bind("mouseleave.markItUp",function(){b("> ul",this).hide()}).appendTo(f);a.dropMenu&&(y.push(c),b(e).addClass("markItUpDropMenu").append(x(a.dropMenu)))}});y.pop();return f}function N(a){return a?(a=a.toString(),a=a.replace(/\(\!\(([\s\S]*?)\)\!\)/g,function(a,b){var c=b.split("|!|");return!0===w?void 0!==c[1]?c[1]:c[0]:void 0===c[1]?"":c[0]}),a=a.replace(/\[\!\[([\s\S]*?)\]\!\]/g,function(a,b){var c=b.split(":!:");
if(!0===z)return!1;value=prompt(c[0],c[1]?c[1]:"");null===value&&(z=!0);return value})):""}function q(a){b.isFunction(a)&&(a=a(v));return N(a)}function D(a){var b=q(r.openWith),c=q(r.placeHolder),e=q(r.replaceWith),d=q(r.closeWith),h=q(r.openBlockWith),k=q(r.closeBlockWith),g=r.multiline;if(""!==e)block=b+e+d;else if(""===selection&&""!==c)block=b+c+d;else{a=a||selection;var l=[a],m=[];!0===g&&(l=a.split(/\r?\n/));for(a=0;a<l.length;a++){line=l[a];var n;(n=line.match(/ *$/))?m.push(b+line.replace(/ *$/g,
"")+d+n):m.push(b+line+d)}block=m.join("\n")}block=h+block+k;return{block:block,openBlockWith:h,openWith:b,replaceWith:e,placeHolder:c,closeWith:d,closeBlockWith:k}}function u(a){var f,g,p;v=r=a;C();b.extend(v,{line:"",root:c.root,textarea:e,selection:selection||"",caretPosition:k,ctrlKey:h,shiftKey:n,altKey:w});q(c.beforeInsert);q(r.beforeInsert);(!0===h&&!0===n||!0===a.multiline)&&q(r.beforeMultiInsert);b.extend(v,{line:1});if(!0===h&&!0===n){lines=selection.split(/\r?\n/);f=0;g=lines.length;for(p=
0;p<g;p++)""!==b.trim(lines[p])?(b.extend(v,{line:++f,selection:lines[p]}),lines[p]=D(lines[p]).block):lines[p]="";string={block:lines.join("\n")};start=k;f=string.block.length+(l.opera?g-1:0)}else!0===h?(string=D(selection),start=k+string.openWith.length,f=string.block.length-string.openWith.length-string.closeWith.length,f-=string.block.match(/ $/)?1:0,f-=F(string.block)):!0===n?(string=D(selection),start=k,f=string.block.length,f-=F(string.block)):(string=D(selection),start=k+string.block.length,
f=0,start-=F(string.block));""===selection&&""===string.replaceWith&&(m+=L(string.block),start=k+string.openBlockWith.length+string.openWith.length,f=string.block.length-string.openBlockWith.length-string.openWith.length-string.closeWith.length-string.closeBlockWith.length,m=d.val().substring(k,d.val().length).length,m-=L(d.val().substring(0,k)));b.extend(v,{caretPosition:k,scrollPosition:E});string.block!==selection&&!1===z?(g=string.block,document.selection?document.selection.createRange().text=
g:e.value=e.value.substring(0,k)+g+e.value.substring(k+selection.length,e.value.length),M(start,f)):m=-1;C();b.extend(v,{line:"",selection:selection});(!0===h&&!0===n||!0===a.multiline)&&q(r.afterMultiInsert);q(r.afterInsert);q(c.afterInsert);s&&c.previewAutoRefresh&&K();n=w=h=z=!1}function L(a){return l.opera?a.length-a.replace(/\n*/g,"").length:0}function F(a){return l.msie?a.length-a.replace(/\r*/g,"").length:0}function M(a,b){if(e.createTextRange){if(l.opera&&9.5<=l.version&&0==b)return!1;range=
e.createTextRange();range.collapse(!0);range.moveStart("character",a);range.moveEnd("character",b);range.select()}else e.setSelectionRange&&e.setSelectionRange(a,a+b);e.scrollTop=E;e.focus()}function C(){e.focus();E=e.scrollTop;if(document.selection)if(selection=document.selection.createRange().text,l.msie){var a=document.selection.createRange(),b=a.duplicate();b.moveToElementText(e);for(k=-1;b.inRange(a);)b.moveStart("character"),k++}else k=e.selectionStart;else k=e.selectionStart,selection=e.value.substring(k,
e.selectionEnd);return selection}function K(){if(c.previewHandler&&"function"===typeof c.previewHandler)c.previewHandler(d.val());else if(c.previewParser&&"function"===typeof c.previewParser){var a=c.previewParser(d.val());G(g(a,1))}else""!==c.previewParserPath?b.ajax({type:"POST",dataType:"text",global:!1,url:c.previewParserPath,data:c.previewParserVar+"="+encodeURIComponent(d.val()),success:function(a){G(g(a,1))}}):O||b.ajax({url:c.previewTemplatePath,dataType:"text",global:!1,success:function(a){G(g(a,
1).replace(/\x3c!-- content --\x3e/g,d.val()))}});return!1}function G(a){if(c.previewInElement)b(c.previewInElement).html(a);else if(s&&s.document){try{sp=s.document.documentElement.scrollTop}catch(d){sp=0}s.document.open();s.document.write(a);s.document.close();s.document.documentElement.scrollTop=sp}}function J(a){n=a.shiftKey;h=(w=a.altKey)&&a.ctrlKey?!1:a.ctrlKey||a.metaKey;if("keydown"===a.type){if(!0===h&&(li=b('a[accesskey="'+(13==a.keyCode?"\\n":String.fromCharCode(a.keyCode))+'"]',B).parent("li"),
0!==li.length))return h=!1,setTimeout(function(){li.triggerHandler("mouseup")},1),!1;if(13===a.keyCode||10===a.keyCode){if(!0===h)return h=!1,u(c.onCtrlEnter),c.onCtrlEnter.keepDefault;if(!0===n)return n=!1,u(c.onShiftEnter),c.onShiftEnter.keepDefault;u(c.onEnter);return c.onEnter.keepDefault}if(9===a.keyCode){if(!0==n||!0==h||!0==w)return!1;if(-1!==m)return C(),m=d.val().length-m,M(m,0),m=-1,!1;u(c.onTab);return c.onTab.keepDefault}}}var d,e,y,E,k,m,r,v,B,I,s,O,z;d=b(this);e=this;y=[];z=!1;E=k=0;
m=-1;c.previewParserPath=g(c.previewParserPath);c.previewTemplatePath=g(c.previewTemplatePath);if(A)switch(A){case "remove":d.unbind(".markItUp").removeClass("markItUpEditor");d.parent("div").parent("div.markItUp").parent("div").replaceWith(d);d.data("markItUp",null);break;case "insert":u(H);break;default:b.error("Method "+A+" does not exist on jQuery.markItUp")}else t()})};b.fn.markItUpRemove=function(){return this.each(function(){b(this).markItUp("remove")})};b.markItUp=function(t){var g={target:!1};
b.extend(g,t);if(g.target)return b(g.target).each(function(){b(this).focus();b(this).trigger("insertion",[g])});b("textarea").trigger("insertion",[g])}})(jQuery);
